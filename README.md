# 🌳 Soul Tree Hole (心灵树洞)

## 📖 项目简介
**Soul Tree Hole** 是一个基于 **Spring Boot** 和 **MyBatis** 构建的匿名社交树洞平台。项目旨在为用户提供一个安全、私密的倾诉空间。

本项目不仅仅是一个简单的 CRUD 练习，更是一个在**用户交互体验**、**安全验证机制**和**业务逻辑完整性**上追求极致的 Web 全栈项目。前端完全采用**原生 JavaScript** 实现，摒弃了 Vue/React 等框架的依赖，回归 Web 开发的本源，展现了扎实的 DOM 操作与事件处理功底。

## ✨ 核心亮点与实现原理

### 🛡️ 七重安全验证卫士 (Captcha System)
本项目实现了一套高度可配置、支持热切换的混合验证码系统，有效抵御自动化脚本攻击。

#### 1. 滑动拼图验证 (Jigsaw Captcha) - *交互与安全的平衡*
*   **核心逻辑**：
    *   **后端 (`CaptchaUtil.java`)**：使用 Java 2D `GeneralPath` 绘制不规则拼图形状。随机生成缺口坐标 `(x, y)`，从原图中裁剪出滑块并添加描边，同时在原图绘制半透明蒙版。将正确的 `x` 坐标加密存储于 `HttpSession`。
    *   **前端**：监听 `mousedown/mousemove/mouseup` 事件实现拖拽。用户松开时，计算滑块位移并发送给后端。
    *   **校验**：后端比对用户提交的偏移量与 Session 中的值，允许 **±5px** 的误差范围，兼顾安全性与用户体验。

#### 2. 文字点选验证 (TextClick Captcha) - *高强度人机识别*
*   **核心逻辑**：
    *   **后端**：随机选取 3 个汉字（如“梦、云、海”），随机颜色、角度绘制在背景图上。采用简单的**碰撞检测算法**防止文字重叠。将 3 个汉字的中心坐标列表存入 Session。
    *   **前端**：用户点击图片时，在点击处动态生成数字标记 (1, 2, 3)。
    *   **校验**：计算用户点击坐标与预存坐标的**欧氏距离**。只有当每个点击点都在对应汉字的判定半径（30px）内时，验证通过。

#### 3. GalGame 趣味验证 - *二次元特色*
*   **核心逻辑**：
    *   **自动分类**：后端启动时扫描 `static/captchaForGal` 目录，根据文件名（如`白毛1.jpg`, `紫毛2.jpg`）自动提取特征标签。
    *   **出题逻辑**：随机选择一个“目标特征”（如“白毛”），并从其他分类中随机抽取干扰图片，组成选项列表。
    *   **校验**：比对用户选择的图片索引与正确答案索引。

#### 4. 常规图形验证 - *Hutool 强力驱动*
*   集成 Hutool 工具库，提供线段干扰、圆圈干扰、扭曲干扰、GIF 动态帧四种基础验证模式，作为备用方案。

---

### 💻 业务功能与架构设计

#### 1. 树洞内容管理 (Hole Core)
*   **内容发布**：支持用户发布树洞内容，可选择分类（白日、黑夜、开心、不开心）。
*   **智能展示**：
    *   **Top 10 热门**：根据点赞数实时计算热门树洞，首页轮播展示。
    *   **分类筛选**：支持按情绪分类筛选内容，并自动切换页面主题色调。
*   **独立卡片交互**：采用 CSS Grid 布局，解决了卡片高度联动问题，实现点击展开/收起的独立状态管理。

#### 2. 全新个人中心 (User Center 2.0)
*   **个人资料**：
    *   支持头像上传与实时预览（存储于本地文件系统）。
    *   昵称修改与密码安全变更。
*   **多维度内容管理**：
    *   **我的发布**：查看并管理自己发布的树洞。
    *   **我的收藏**：快速找回感兴趣的内容。
    *   **我的关注**：管理关注的用户列表，支持查看“特别关注”状态。

#### 3. 深度社交关系 (Social Graph)
*   **关注体系**：
    *   **关注/取消关注**：构建用户间的连接。
    *   **特别关注**：为重要的人设置星标，高亮显示。
*   **用户卡片**：
    *   在任意位置点击头像，弹出用户悬浮卡片。
    *   卡片内展示用户最近动态，并提供**快捷私信**入口。
*   **私信系统**：支持用户间发送点对点消息，构建私密沟通渠道。

#### 4. 时光胶囊 (Time Capsule)
*   **寄给未来的信**：用户可以埋下胶囊，设定未来的开启时间。
*   **封印与解封**：未到期胶囊处于锁定状态，到期后自动解锁并发送通知提醒。
*   **仪式感动画**：埋下胶囊时触发纸飞机飞行动画，寓意愿望的寄托。

#### 5. 通知中心 (Notification Hub)
*   **实时反馈**：聚合点赞通知、关注提醒。
*   **胶囊送达**：当埋下的时光胶囊到期时，第一时间通知用户开启。

#### 6. 前端沉浸式体验 (Frontend Magic)
*   **乐观 UI 更新 (Optimistic UI)**：在点赞、关注等高频操作中，先立即更新界面状态，再后台发送请求，提供零延迟的流畅体验。
*   **动态背景系统**：
    *   **氛围营造**：根据选择的树洞分类（如“黑夜”），自动切换背景图（如 `newForest.png`）与主题色。
    *   **落叶动画**：保留了经典的 CSS3 落叶飘落效果，增强视觉沉浸感。

#### 7. AI 树洞伙伴 (AI Companion) - *DeepSeek 驱动的智能伴侣*
本项目集成了最前沿的 **DeepSeek-V3** 大语言模型（通过 SiliconFlow API），为用户打造了一个懂你、暖你、逗你的全天候 AI 伙伴。

*   **🧠 核心架构与实现**：
    *   **后端技术**：采用 JDK 11+ 原生 `java.net.http.HttpClient` 实现与大模型 API 的高效通信，无额外第三方 HTTP 库依赖，轻量且高性能。
    *   **上下文记忆 (Context Awareness)**：实现了基于 Session 的多轮对话机制。后端自动检索最近 **20 条** 历史记录作为 Prompt 上下文发送给模型，确保 AI 拥有“记忆”，能理解对话的前因后果。
    *   **数据持久化**：所有聊天记录均存储于 MySQL `ai_message` 表中，支持跨设备同步与历史回溯。

*   **🎭 Prompt Engineering (角色扮演)**：
    通过精心设计的 System Prompt（系统提示词），赋予 AI 鲜活的性格特征：
    *   **通用 AI**：理性客观的助手，负责陪伴用户，倾听心声。
    *   **暖暖 (情感抚慰)**：设定为温柔知性的心理咨询师，擅长共情与情绪疏导，回复风格温暖治愈。
    *   **守树人 (树洞守护)**：设定为沉稳睿智的守护者，像一位老者守护秘密，给迷茫的人指引方向。
    *   **乐乐 (开心果)**：设定为幽默风趣的伙伴，擅长讲笑话和玩梗，专治各种不开心。

*   **🎨 沉浸式前端交互**：
    *   **独立聊天界面**：全新设计的 `ai_chat.html`，采用**毛玻璃 (Glassmorphism)** 视觉风格，与主站审美保持一致。
    *   **动态交互体验**：
        *   **流式体验模拟**：前端实现“正在思考 (Thinking...)”状态动画，提升等待时的交互感。
        *   **个性化装扮**：内置**背景图库**与**透明度调节**功能，用户可定制专属聊天氛围。
        *   **丰富的表达**：集成 Emoji 表情面板与颜文字库 (`(・ω・)`), 让沟通更有趣。
        *   **Markdown 渲染**：完美支持代码块、列表、加粗等富文本格式显示 AI 回复。

## 🛠️ 技术栈清单

### 后端 (Backend)
- **Framework**: Spring Boot 3.x (极速开发)
- **ORM**: MyBatis (灵活的 SQL 控制)
- **Database**: MySQL 8.0 (数据持久化)
- **Tools**: Hutool (瑞士军刀般的 Java 工具库)
- **AI Integration**: SiliconFlow API (DeepSeek-V3 Model)
- **Build**: Maven

### 前端 (Frontend)
- **Core**: HTML5, CSS3, Vanilla JavaScript (ES6+)
- **Layout**: CSS Grid & Flexbox (现代布局方案)
- **Network**: Fetch API (现代化的网络请求)
- **Icons**: RemixIcon (精美开源图标库)
- **Components**: Flatpickr (优雅的日期选择器)

## 🚀 快速启动指南

### 1. 环境准备
- JDK 17 或更高版本
- MySQL 8.0+
- Maven 3.6+

### 2. 数据库配置
1. 创建数据库：`CREATE DATABASE tree_hole DEFAULT CHARACTER SET utf8mb4;`
2. 导入数据表结构（参考 `entry` 包下的实体类字段）。
3. 修改配置文件 `src/main/resources/application.yml`：
   ```yaml
   spring:
     datasource:
       url: jdbc:mysql://localhost:3306/tree_hole?serverTimezone=Asia/Shanghai&useSSL=false
       username: root  # 你的数据库账号
       password: root  # 你的数据库密码
   ```

### 3. 运行项目
在项目根目录下执行：
```bash
mvn spring-boot:run
```
或在 IDEA 中运行 `TreeHoleApplication.java`。

访问地址：`http://localhost:8080/login.html`

## 📂 核心目录结构
```
src/main/java/org/example/treehole/
├── controller/      # 控制层：接收前端请求 (HoleController, UserFollowController, TimeCapsuleController)
├── service/         # 业务层：核心逻辑 (HoleService, UserFollowService)
├── mapper/          # 持久层：MyBatis 接口
├── entry/           # 实体类：Hole, User, UserFollow, TimeCapsule
├── util/            # 工具类：CaptchaUtil (核心验证码生成逻辑)
└── ...
```

---
*本项目代码清晰，注释详尽，适合作为 Java Web 入门进阶的参考案例。*
